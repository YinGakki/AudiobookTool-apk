<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¿—ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header .icon {
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .controls {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .file-tabs {
            display: flex;
            gap: 8px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: white;
            color: #495057;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .tab-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .refresh-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        
        .status {
            padding: 10px 20px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin: 10px 20px;
            border-radius: 0 6px 6px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .status-text {
            color: #1565c0;
            font-weight: 500;
            font-size: 13px;
        }
        
        .status-time {
            color: #666;
            font-size: 12px;
        }
        
        .log-container {
            padding: 0 20px 20px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .log-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .log-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .log-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
        }
        
        .log-entry {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
        }
        
        .log-entry:hover {
            background: #f8f9fa;
        }
        
        .log-time {
            flex: 0 0 150px;
            color: #666;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            padding: 3px 8px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-right: 12px;
            height: fit-content;
        }
        
        .log-content {
            flex: 1;
            color: #333;
            line-height: 1.4;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        /* JSONè¡¨æ ¼æ ·å¼ */
        .json-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .json-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

		
        .json-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 12px;
        }
        
        .json-table tr:hover {
            background: #f8f9fa;
        }
        
        .json-table tr:last-child td {
            border-bottom: none;
        }
        
        .key-cell {
            font-family: 'Courier New', monospace;
            background: #f1f3f4;
            padding: 6px 10px;
            border-radius: 4px;
            font-weight: 500;
            word-break: break-all;
            max-width: 200px;
        }
        
        .alias-cell {
            font-weight: 600;
            color: #495057;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-available {
            background: #d4edda;
            color: #155724;
        }
        
        .status-unavailable {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-unknown {
            background: #fff3cd;
            color: #856404;
        }
        
        .action-btn {
            padding: 4px 8px;
            font-size: 11px;
            border: 1px solid #ccc;
            background: #f8f9fa;
            color: #495057;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
		
		.action-btn-danger {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .action-btn-danger:hover {
            background: #f1b0b7;
            border-color: #e2a3aa;
        }
		
		.status-in-use {
            background: #cce5ff;
            color: #004085;
        }
		
        .time-cell {
            color: #666;
            font-size: 11px;
            font-family: 'Courier New', monospace;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 20px;
            border-left: 4px solid #f44336;
            font-size: 13px;
        }
        
        .empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-icon {
            font-size: 36px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .file-tabs {
                justify-content: center;
            }
            
            .refresh-controls {
                justify-content: center;
            }
            
            .log-time {
                flex: 0 0 100px;
                font-size: 10px;
            }
            
            .log-content {
                font-size: 11px;
            }
            
            .json-table {
                font-size: 11px;
            }
            
            .json-table th, .json-table td {
                padding: 8px;
            }
            
            .key-cell {
                max-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <div class="icon">ğŸ“‹</div>
                æ—¥å¿—ç›‘æ§ç³»ç»Ÿ
            </h1>
            <div id="currentTime"></div>
        </div>
        
        <div class="controls">
            <div class="file-tabs">
                <button class="tab-btn active" data-type="output">Outputæ—¥å¿—</button>
                <button class="tab-btn" data-type="key">Keyæ—¥å¿—</button>
                <button class="tab-btn" data-type="key-management">å¯†é’¥ç®¡ç†</button>
            </div>
            
            <div class="refresh-controls">
                <div class="auto-refresh">
                    <label class="switch">
                        <input type="checkbox" id="autoRefresh">
                        <span class="slider"></span>
                    </label>
                    <span>è‡ªåŠ¨åˆ·æ–° (5ç§’)</span>
                </div>
                <button class="refresh-btn" id="refreshBtn">
                    <span>ğŸ”„</span>
                    <span>ç«‹å³åˆ·æ–°</span>
                </button>
            </div>
        </div>
        
        <div class="status">
            <div class="status-text">
                å½“å‰æ–‡ä»¶: <span id="currentFile">Outputæ—¥å¿—</span> | 
                æ€»è®°å½•æ•°: <span id="totalRecords">0</span>
            </div>
            <div class="status-time" id="lastUpdate">æœ€åæ›´æ–°: --</div>
        </div>
        
        <div class="log-container" id="logContainer">
            <div class="loading">
                <div class="spinner"></div>
                <div>æ­£åœ¨åŠ è½½æ—¥å¿—...</div>
            </div>
        </div>
    </div>

    <script>
        let currentFileType = 'output';
        let refreshInterval = null;
        
        // æ–‡ä»¶ç±»å‹æ˜ å°„
        const fileTypeNames = {
            'output': 'Outputæ—¥å¿—',
            'key': 'Keyæ—¥å¿—',
			'key-management': 'å¯†é’¥ç®¡ç†' // æ–°å¢
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            //startAutoRefresh();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            loadLogs();
        });
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            // æ–‡ä»¶ç±»å‹åˆ‡æ¢
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFileType = this.dataset.type;
                    document.getElementById('currentFile').textContent = fileTypeNames[currentFileType];
                    loadLogs();
                });
            });
            
            // åˆ·æ–°æŒ‰é’®
            document.getElementById('refreshBtn').addEventListener('click', function() {
                loadLogs();
            });
            
            // è‡ªåŠ¨åˆ·æ–°å¼€å…³
            document.getElementById('autoRefresh').addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
        }
        
        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            const container = document.getElementById('logContainer');
            const refreshBtn = document.getElementById('refreshBtn');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨åŠ è½½æ—¥å¿—...</div>
                </div>
            `;
            
            refreshBtn.disabled = true;
            
            try {
                const response = await fetch(`/get_logs?file_type=${currentFileType}`);
                const data = await response.json();
                
                if (response.ok) {
                    if (currentFileType === 'api') {
                        displayJsonTable(data.logs);
					} else if (currentFileType === 'key-management') {
                        // å¦‚æœæ˜¯å¯†é’¥ç®¡ç†é¡µé¢ï¼Œè°ƒç”¨æ–°çš„APIå¹¶æ¸²æŸ“
                        loadAndDisplayKeyManagement();
                    } else {
                        displayLogs(data.logs);
                    }
                    document.getElementById('totalRecords').textContent = data.total;
                    document.getElementById('lastUpdate').textContent = 
                        `æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}`;
                } else {
                    throw new Error('è¯·æ±‚å¤±è´¥');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="error">
                        âŒ åŠ è½½æ—¥å¿—å¤±è´¥: ${error.message}
                    </div>
                `;
            } finally {
                refreshBtn.disabled = false;
            }
        }
        
        // æ˜¾ç¤ºæ™®é€šæ—¥å¿—
        function displayLogs(logs) {
            const container = document.getElementById('logContainer');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>æš‚æ— æ—¥å¿—è®°å½•</div>
                    </div>
                `;
                return;
            }
            
            const html = logs.map(log => `
                <div class="log-entry">
                    <div class="log-time">${escapeHtml(log.time)}</div>
                    <div class="log-content">${escapeHtml(log.content)}</div>
                </div>
            `).join('');
            
            container.innerHTML = html;
            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }
        
        // æ˜¾ç¤ºJSONè¡¨æ ¼
        function displayJsonTable(logs) {
            const container = document.getElementById('logContainer');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>æš‚æ— APIè®°å½•</div>
                    </div>
                `;
                return;
            }
            
            // å°è¯•è§£æJSONæ•°æ®
            let jsonData = [];
            try {
                // æŸ¥æ‰¾JSONå†…å®¹è¡Œ
                const jsonLine = logs.find(log => log.content.includes('[') || log.content.includes('{'));
                if (jsonLine) {
                    const content = jsonLine.content.replace(/=== JSON æ–‡ä»¶å†…å®¹ ===/, '').trim();
                    jsonData = JSON.parse(content);
                }
            } catch (e) {
                // å¦‚æœè§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹å†…å®¹
                displayLogs(logs);
                return;
            }
            
            if (!Array.isArray(jsonData) || jsonData.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>æš‚æ— APIè®°å½•</div>
                    </div>
                `;
                return;
            }
            
            const html = `
                <table class="json-table">
                    <thead>
                        <tr>
                            <th>API Key</th>
                            <th>åˆ«å</th>
                            <th>çŠ¶æ€</th>
                            <th>æœ€åä½¿ç”¨æ—¶é—´</th>
							<th>æ“ä½œ</th> <!-- æ–°å¢è¿™ä¸€åˆ— -->
                        </tr>
                    </thead>
                    <tbody>
                        ${jsonData.map(item => `
                            <tr>
                                <td><div class="key-cell">${escapeHtml(item.key || '')}</div></td>
                                <td class="alias-cell">${escapeHtml(item.alias || '')}</td>
                                <td>${getStatusBadge(item.status || '')}</td>
                                <td class="time-cell">${formatDateTime(item.last_used || '')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // è·å–çŠ¶æ€å¾½ç« 
        function getStatusBadge(status) {
            const statusText = status.toString().toLowerCase();
            let className = 'status-unknown';
            let displayText = status;
            
            if (statusText === 'å¯ç”¨' || statusText === 'available' || statusText === 'æ­£å¸¸') {
                className = 'status-available';
                displayText = 'âœ… ' + status;
            } else if (statusText === 'ä¸å¯ç”¨' || statusText === 'unavailable' || statusText === 'å¤±æ•ˆ') {
                className = 'status-unavailable';
                displayText = 'âŒ ' + status;
            } else if (statusText === 'æ­£åœ¨ä½¿ç”¨') {
                className = 'status-in-use'; 
                displayText = 'ğŸŸ¢ ' + status;
            }
            
            return `<span class="status-badge ${className}">${displayText}</span>`;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateStr) {
            if (!dateStr) return '--';
            try {
                const date = new Date(dateStr);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (e) {
                return dateStr;
            }
        }
        
        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            stopAutoRefresh();
            refreshInterval = setInterval(loadLogs, 5000);
        }
        
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // æ›´æ–°å½“å‰æ—¶é—´
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }
        
        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

// --- æ–°å¢å‡½æ•°ï¼šåŠ è½½å¹¶æ˜¾ç¤ºå¯†é’¥ç®¡ç†é¡µé¢ ---
async function loadAndDisplayKeyManagement() {
    const container = document.getElementById('logContainer');
    const refreshBtn = document.getElementById('refreshBtn');

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <div>æ­£åœ¨åŠ è½½å¯†é’¥çŠ¶æ€...</div>
        </div>
    `;
    
    refreshBtn.disabled = true;

    try {
        // 1. è·å–å¯†é’¥çŠ¶æ€
        const statusResponse = await fetch('/get_key_status');
        const statusData = await statusResponse.json();

        if (!statusResponse.ok || !statusData.success) {
            throw new Error(statusData.message || 'è·å–å¯†é’¥çŠ¶æ€å¤±è´¥');
        }

        // 2. æ¸²æŸ“å¯†é’¥ç®¡ç†ç•Œé¢
        displayKeyManagementPage(statusData);

    } catch (error) {
        container.innerHTML = `
            <div class="error">
                âŒ åŠ è½½å¯†é’¥ç®¡ç†é¡µé¢å¤±è´¥: ${error.message}
            </div>
        `;
    } finally {
        refreshBtn.disabled = false;
    }
}

// --- æ–°å¢å‡½æ•°ï¼šæ¸²æŸ“å¯†é’¥ç®¡ç†é¡µé¢çš„HTML ---
function displayKeyManagementPage(statusData) {
    const container = document.getElementById('logContainer');

    const html = `
        <div style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h3 style="margin: 0; color: #495057;">å¯†é’¥æ± çŠ¶æ€æ€»è§ˆ</h3>
                    <p style="margin: 5px 0 0; color: #6c757d; font-size: 13px;">
                        å½“å‰å¯†é’¥: <strong>${escapeHtml(statusData.current_key_alias)}</strong> | 
                        æ€»æ•°: <strong>${statusData.total_keys}</strong> | 
                        å¯ç”¨: <strong style="color: #28a745;">${statusData.available_keys}</strong> | 
                        ä¸å¯ç”¨: <strong style="color: #dc3545;">${statusData.unavailable_keys}</strong>
                    </p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="refresh-btn" id="rotateKeyBtn" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
                        <span>ğŸ”„</span>
                        <span>ç«‹å³è½®æ¢å¯†é’¥</span>
                    </button>
                    <button class="refresh-btn" onclick="showAddKeyDialog()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <span>â•</span>
                        <span>æ–°å¢å¯†é’¥</span>
                    </button>
                </div>
            </div>

            <table class="json-table">
                <thead>
                    <tr>
                        <th>API Key</th>
                        <th>åˆ«å</th>
                        <th>çŠ¶æ€</th>
                        <th>æœ€åä½¿ç”¨æ—¶é—´</th>
						<th>æ“ä½œ</th> <!-- æ–°å¢è¿™ä¸€åˆ— -->
                    </tr>
                </thead>
                <tbody>
                    ${statusData.pool_details.map(item => `
                        <tr>
                            <td><div class="key-cell">${escapeHtml(maskApiKey(item.key || ''))}</div></td>
                            <td class="alias-cell">${escapeHtml(item.alias || '')}</td>
                            <td>${getStatusBadge(item.status || '')}</td>
                            <td class="time-cell">${formatDateTime(item.last_used || '')}</td>
                            <td>${getActionButtons(item)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;

    // ä¸ºæ–°åˆ›å»ºçš„â€œè½®æ¢å¯†é’¥â€æŒ‰é’®ç»‘å®šäº‹ä»¶
    document.getElementById('rotateKeyBtn').addEventListener('click', triggerKeyRotation);
}

// --- æ–°å¢å‡½æ•°ï¼šè§¦å‘å¯†é’¥è½®æ¢ ---
async function triggerKeyRotation() {
    const btn = document.getElementById('rotateKeyBtn');
    const originalText = btn.innerHTML;
    
    // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    btn.disabled = true;
    btn.innerHTML = '<span>â³</span><span>æ­£åœ¨æ‰§è¡Œ...</span>';

    try {
        // ä½¿ç”¨æµè§ˆå™¨å¼¹çª—è®©ç”¨æˆ·è¾“å…¥è®¤è¯ä¿¡æ¯
        const username = prompt("è¯·è¾“å…¥ç”¨æˆ·å:");
        const password = prompt("è¯·è¾“å…¥å¯†ç :");

        if (!username || !password) {
            alert("ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼");
            return; // ä¸­æ­¢æ“ä½œ
        }

        const response = await fetch('/rotate_key', {
            method: 'POST',
            headers: {
                'Authorization': 'Basic ' + btoa(username + ':' + password)
            }
        });

        const result = await response.json();

        if (response.ok && result.success) {
            alert('âœ… ' + result.message);
            // è½®æ¢æˆåŠŸåï¼Œåˆ·æ–°å¯†é’¥ç®¡ç†é¡µé¢
            loadAndDisplayKeyManagement();
        } else {
            alert('âŒ æ“ä½œå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// --- æ–°å¢å‡½æ•°ï¼šåŠ è½½å¹¶æ˜¾ç¤ºå¯†é’¥ç®¡ç†é¡µé¢ ---
async function loadAndDisplayKeyManagement() {
    const container = document.getElementById('logContainer');
    const refreshBtn = document.getElementById('refreshBtn');

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <div>æ­£åœ¨åŠ è½½å¯†é’¥çŠ¶æ€...</div>
        </div>
    `;
    
    refreshBtn.disabled = true;

    try {
        // 1. è·å–å¯†é’¥çŠ¶æ€
        const statusResponse = await fetch('/get_key_status');
        const statusData = await statusResponse.json();

        if (!statusResponse.ok || !statusData.success) {
            throw new Error(statusData.message || 'è·å–å¯†é’¥çŠ¶æ€å¤±è´¥');
        }

        // 2. æ¸²æŸ“å¯†é’¥ç®¡ç†ç•Œé¢
        displayKeyManagementPage(statusData);

    } catch (error) {
        container.innerHTML = `
            <div class="error">
                âŒ åŠ è½½å¯†é’¥ç®¡ç†é¡µé¢å¤±è´¥: ${error.message}
            </div>
        `;
    } finally {
        refreshBtn.disabled = false;
    }
}


// åœ¨ log_monitor.html çš„ <script> ä¸­æ‰¾åˆ° getActionButtons å‡½æ•°
function getActionButtons(item) {
    const status = item.status;
    let buttons = '';

    if (status === 'å¯ç”¨') {
        buttons += `<button class="action-btn" onclick="updateKeyStatus('${item.key}', 'ä¸å¯ç”¨')">è®¾ä¸ºä¸å¯ç”¨</button>`;
    } else if (status === 'ä¸å¯ç”¨') {
        buttons += `<button class="action-btn" onclick="updateKeyStatus('${item.key}', 'å¯ç”¨')">è®¾ä¸ºå¯ç”¨</button>`;
    }
    
    // ä¸ºéâ€œæ­£åœ¨ä½¿ç”¨â€çŠ¶æ€çš„å¯†é’¥æ·»åŠ åˆ é™¤æŒ‰é’®
    if (status !== 'æ­£åœ¨ä½¿ç”¨') {
        buttons += `<button class="action-btn action-btn-danger" onclick="deleteKey('${item.key}')">åˆ é™¤</button>`;
    }

    return buttons;
}

function showAddKeyDialog() {
    // ç®€å•çš„promptæ–¹å¼ï¼Œä½ å¯ä»¥æ›¿æ¢ä¸ºæ›´ç¾è§‚çš„æ¨¡æ€æ¡†
    const newKey = prompt("è¯·è¾“å…¥æ–°çš„API Key:");
    if (!newKey) return;

    const newAlias = prompt("è¯·è¾“å…¥è¯¥å¯†é’¥çš„åˆ«å:");
    if (!newAlias) return;

    addNewKey(newKey, newAlias);
}

// åœ¨ <script> æœ«å°¾æ·»åŠ 

// --- æ–°å¢å‡½æ•°ï¼šä¿®æ”¹å¯†é’¥çŠ¶æ€ ---
async function updateKeyStatus(keyToUpdate, newStatus) {
    if (!confirm(`ç¡®å®šè¦å°†æ­¤å¯†é’¥çŠ¶æ€ä¿®æ”¹ä¸º "${newStatus}" å—ï¼Ÿ`)) {
        return;
    }

    try {
        // åˆ é™¤äº†ç”¨æˆ·åå¯†ç è¾“å…¥
        const response = await fetch('/update_key_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
                // 'Authorization' å¤´å·²è¢«ç§»é™¤
            },
            body: JSON.stringify({ key: keyToUpdate, status: newStatus })
        });

        const result = await response.json();
        if (response.ok && result.success) {
            alert('âœ… ' + result.message);
            loadAndDisplayKeyManagement(); // åˆ·æ–°é¡µé¢
        } else {
            alert('âŒ æ“ä½œå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
    }
}


// --- æ–°å¢å‡½æ•°ï¼šæ–°å¢å¯†é’¥ ---
async function addNewKey(newKey, newAlias) {
    try {
        // åˆ é™¤äº†ç”¨æˆ·åå¯†ç è¾“å…¥
        const response = await fetch('/add_new_key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
                // 'Authorization' å¤´å·²è¢«ç§»é™¤
            },
            body: JSON.stringify({ key: newKey, alias: newAlias })
        });

        const result = await response.json();
        if (response.ok && result.success) {
            alert('âœ… ' + result.message);
            loadAndDisplayKeyManagement(); // åˆ·æ–°é¡µé¢
        } else {
            alert('âŒ æ“ä½œå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
    }
}

// åœ¨ <script> æœ«å°¾æ·»åŠ 

// --- æ–°å¢å‡½æ•°ï¼šåˆ é™¤å¯†é’¥ ---
async function deleteKey(keyToDelete) {
    // ä½¿ç”¨æ›´é†’ç›®çš„ç¡®è®¤æ¡†
    if (!confirm(`âš ï¸ ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ­¤å¯†é’¥å—ï¼Ÿ\n\n${maskApiKey(keyToDelete)}\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
    }

    try {
        const response = await fetch('/delete_key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ key: keyToDelete })
        });

        const result = await response.json();
        if (response.ok && result.success) {
            alert('âœ… ' + result.message);
            loadAndDisplayKeyManagement(); // åˆ·æ–°é¡µé¢
        } else {
            alert('âŒ æ“ä½œå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
    }
}

function maskApiKey(key) {
    if (!key || key.length <= 12) {
        // å¦‚æœå¯†é’¥å¤ªçŸ­ï¼Œä¸ºäº†å®‰å…¨ï¼Œå…¨éƒ¨æ˜¾ç¤ºä¸ºæ˜Ÿå·
        return '****';
    }
    const start = key.substring(0, 8);
    const end = key.substring(key.length - 4);
    const maskLength = key.length - 12;
    const mask = '*'.repeat(maskLength);
    return start + mask + end;
}

</script>
</body>
</html>