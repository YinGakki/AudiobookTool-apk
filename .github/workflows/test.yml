# .github/workflows/test.yml
name: Code Quality and Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'

jobs:
  python-quality:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # å…è®¸æ¨é€åˆ°ä»“åº“
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Auto-format code with black
        run: |
          cd backend
          echo "ğŸ”§ Auto-formatting code with black..."
          black . --line-length 127
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«ä¿®æ”¹
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ“ Code was formatted, committing changes..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .
            git commit -m "ğŸ”§ Auto-format code with black" || exit 0
            git push || exit 0
          else
            echo "âœ… Code is already formatted"
          fi

      - name: Auto-format imports with isort
        run: |
          cd backend
          echo "ğŸ”§ Auto-formatting imports with isort..."
          isort . --profile black
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«ä¿®æ”¹
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ“ Imports were formatted, committing changes..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .
            git commit -m "ğŸ”§ Auto-format imports with isort" || exit 0
            git push || exit 0
          else
            echo "âœ… Imports are already formatted"
          fi

      - name: Run linting
        run: |
          cd backend
          echo "ğŸ” Running flake8..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  python-tests:
    runs-on: ubuntu-latest
    needs: python-quality  # ç­‰å¾…æ ¼å¼åŒ–å®Œæˆ
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run tests
        run: |
          cd backend
          python -m pytest tests/ -v --tb=short || true
