name: Release APK

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Create Android project if missing
        run: |
          echo "ðŸ”§ Setting up Android project..."
          
          # å¦‚æžœ android ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
          if [ ! -d "android" ]; then
            echo "ðŸ“ Creating android directory..."
            mkdir -p android
          fi
          
          cd android
          
          # å¦‚æžœ gradlew ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®Œæ•´çš„ Android é¡¹ç›®
          if [ ! -f "gradlew" ]; then
            echo "ðŸ”¨ Creating complete Android project..."
            
            # åˆ›å»ºç›®å½•ç»“æž„
            mkdir -p app/src/main/{java/com/audiobooktool,res/{layout,values},python,assets}
            
            # åˆ›å»º settings.gradle
            echo 'include ":app"' > settings.gradle
            
            # åˆ›å»ºæ ¹ build.gradle
            cat > build.gradle << 'EOF'
buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath "com.android.tools.build:gradle:8.1.0"
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}
EOF
            
            # åˆ›å»º app/build.gradle
            cat > app/build.gradle << 'EOF'
apply plugin: "com.android.application"

android {
    namespace "com.audiobooktool"
    compileSdk 34
    
    defaultConfig {
        applicationId "${{ vars.APPLICATION_ID || 'com.audiobooktool' }}"
        minSdk 21
        targetSdk 34
        versionCode 1
        versionName "${{ github.ref_name }}"
    }
    
    buildTypes {
        release {
            minifyEnabled false
        }
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
}

dependencies {
    implementation "androidx.appcompat:appcompat:1.6.1"
}
EOF
            
            # åˆ›å»º AndroidManifest.xml
            cat > app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.audiobooktool">
    <application
        android:allowBackup="true"
        android:label="Audiobook Tool"
        android:theme="@android:style/Theme.Material.Light">
        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF
            
            # åˆ›å»º MainActivity.java
            cat > app/src/main/java/com/audiobooktool/MainActivity.java << 'EOF'
package com.audiobooktool;
import androidx.appcompat.app.AppCompatActivity;
import android.os.Bundle;
public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
    }
}
EOF
            
            # åˆ›å»º strings.xml
            cat > app/src/main/res/values/strings.xml << 'EOF'
<resources>
    <string name="app_name">Audiobook Tool</string>
</resources>
EOF
            
            # åˆ›å»º gradle.properties
            cat > gradle.properties << 'EOF'
org.gradle.jvmargs=-Xmx2048m
android.useAndroidX=true
EOF
            
            # ä¸‹è½½å¹¶åˆ›å»º gradlew
            echo "ðŸ“¦ Downloading Gradle..."
            wget -q https://services.gradle.org/distributions/gradle-8.4-bin.zip
            unzip -q gradle-8.4-bin.zip
            ./gradle-8.4/bin/gradle wrapper --gradle-version 8.4
            chmod +x gradlew
            
            echo "âœ… Android project created"
          else
            echo "âœ… Android project already exists"
          fi

      - name: Copy backend and frontend files
        run: |
          cd android
          
          echo "ðŸ“‹ Copying project files..."
          mkdir -p app/src/main/{python,assets}
          
          if [ -d "../backend" ]; then
            cp -r ../backend/* app/src/main/python/
            echo "âœ… Backend files copied"
          fi
          
          if [ -d "../frontend" ]; then
            cp -r ../frontend/* app/src/main/assets/
            echo "âœ… Frontend files copied"
          fi

      - name: Build Release APK
        env:
          APP_ID: ${{ vars.APPLICATION_ID || 'com.audiobooktool' }}
          VERSION: ${{ github.ref_name }}
        run: |
          cd android
          
          echo "ðŸ”¨ Building $APP_ID version $VERSION"
          
          # ç¡®ä¿ gradlew å¯æ‰§è¡Œ
          chmod +x gradlew
          
          # æž„å»º
          ./gradlew assembleRelease

      - name: Sign APK
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "ðŸ” Signing APK..."
            cd android
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/keystore.jks
            
            # æ›´æ–° build.gradle æ·»åŠ ç­¾åé…ç½®
            cat >> app/build.gradle << 'EOF'

android {
    signingConfigs {
        release {
            storeFile file('keystore.jks')
            storePassword System.getenv("KEYSTORE_PASSWORD")
            keyAlias System.getenv("KEY_ALIAS")
            keyPassword System.getenv("KEY_PASSWORD")
        }
    }
    buildTypes {
        release {
            signingConfig signingConfigs.release
        }
    }
}
EOF
            
            # é‡æ–°æž„å»ºç­¾åçš„ APK
            ./gradlew assembleRelease
          else
            echo "âš ï¸ No keystore configured, using unsigned APK"
          fi

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 90

      - name: Create Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          name: Audiobook Tool ${{ github.ref_name }}
          body: |
            ## ðŸŽ‰ Audiobook Tool ${{ github.ref_name }}
            
            ### ðŸ“± ä¸‹è½½ä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ github.ref_name }}
            - **æž„å»º**: ${{ github.run_number }}
            - **æäº¤**: ${{ github.sha }}
            
            ### ðŸ”§ å®‰è£…è¯´æ˜Ž
            1. ä¸‹è½½ `app-release.apk`
            2. åœ¨ Android è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
            3. å®‰è£… APK æ–‡ä»¶
            
          files: android/app/build/outputs/apk/release/app-release.apk
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
