name: Build Android APK

on:
  push:
    branches: [ main, develop ]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Create Android project
        run: |
          echo "ðŸ”§ Creating Android project structure..."
          
          # åˆ›å»ºç›®å½•
          mkdir -p android/{app/src/main/{java,res/{layout,values},python,assets},gradle/wrapper}
          
          # åˆ›å»º settings.gradle
          echo 'include ":app"' > android/settings.gradle
          
          # åˆ›å»ºæ ¹ build.gradle
          echo 'buildscript {' > android/build.gradle
          echo '    repositories {' >> android/build.gradle
          echo '        google()' >> android/build.gradle
          echo '        mavenCentral()' >> android/build.gradle
          echo '    }' >> android/build.gradle
          echo '    dependencies {' >> android/build.gradle
          echo '        classpath "com.android.tools.build:gradle:8.1.0"' >> android/build.gradle
          echo '    }' >> android/build.gradle
          echo '}' >> android/build.gradle
          echo '' >> android/build.gradle
          echo 'allprojects {' >> android/build.gradle
          echo '    repositories {' >> android/build.gradle
          echo '        google()' >> android/build.gradle
          echo '        mavenCentral()' >> android/build.gradle
          echo '    }' >> android/build.gradle
          echo '}' >> android/build.gradle
          
          # åˆ›å»º app/build.gradle
          echo 'apply plugin: "com.android.application"' > android/app/build.gradle
          echo '' >> android/app/build.gradle
          echo 'android {' >> android/app/build.gradle
          echo '    namespace "com.audiobooktool"' >> android/app/build.gradle
          echo '    compileSdk 34' >> android/app/build.gradle
          echo '    ' >> android/app/build.gradle
          echo '    defaultConfig {' >> android/app/build.gradle
          echo '        applicationId "com.audiobooktool"' >> android/app/build.gradle
          echo '        minSdk 21' >> android/app/build.gradle
          echo '        targetSdk 34' >> android/app/build.gradle
          echo '        versionCode 1' >> android/app/build.gradle
          echo '        versionName "1.0"' >> android/app/build.gradle
          echo '    }' >> android/app/build.gradle
          echo '    ' >> android/app/build.gradle
          echo '    buildTypes {' >> android/app/build.gradle
          echo '        release {' >> android/app/build.gradle
          echo '            minifyEnabled false' >> android/app/build.gradle
          echo '        }' >> android/app/build.gradle
          echo '    }' >> android/app/build.gradle
          echo '}' >> android/app/build.gradle
          echo '' >> android/app/build.gradle
          echo 'dependencies {' >> android/app/build.gradle
          echo '    implementation "androidx.appcompat:appcompat:1.6.1"' >> android/app/build.gradle
          echo '}' >> android/app/build.gradle
          
          # åˆ›å»º gradle.properties
          echo 'org.gradle.jvmargs=-Xmx2048m' > android/gradle.properties
          echo 'android.useAndroidX=true' >> android/gradle.properties
          
          echo "âœ… Configuration files created"

      - name: Download Gradle and create wrapper
        run: |
          cd android
          
          echo "ðŸ“¦ Downloading Gradle..."
          wget -q https://services.gradle.org/distributions/gradle-8.4-bin.zip
          
          echo "ðŸ“‚ Extracting Gradle..."
          unzip -q gradle-8.4-bin.zip
          
          echo "ðŸ”§ Creating Gradle wrapper..."
          ./gradle-8.4/bin/gradle wrapper --gradle-version 8.4
          
          echo "ðŸ”‘ Setting permissions..."
          chmod +x gradlew
          
          echo "âœ… Gradle wrapper created"

      - name: Copy project files
        run: |
          mkdir -p android/app/src/main/{python,assets}
          if [ -d "backend" ]; then
            cp -r backend/* android/app/src/main/python/ 2>/dev/null || true
          fi
          if [ -d "frontend" ]; then
            cp -r frontend/* android/app/src/main/assets/ 2>/dev/null || true
          fi

      - name: Build APK
        run: |
          cd android
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
