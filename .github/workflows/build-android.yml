name: Build Android APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: 8.0

      - name: Prepare Android project
        run: |
          # å¦‚æœæ²¡æœ‰ android ç›®å½•ï¼Œåˆ›å»ºä¸€ä¸ª
          if [ ! -d "android" ]; then
            echo "ğŸ”§ Creating Android project structure..."
            mkdir -p android/{app/src/main/{java,res/{layout,values},python,assets},gradle/wrapper}
            
            # åˆ›å»º settings.gradle
            cat > android/settings.gradle << 'EOF'
include ':app'
EOF
            
            # åˆ›å»º build.gradle
            cat > android/build.gradle << 'EOF'
buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:8.0.0'
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}
EOF
            
            # åˆ›å»º app/build.gradle
            cat > android/app/build.gradle << 'EOF'
apply plugin: 'com.android.application'

android {
    namespace 'com.audiobooktool'
    compileSdk 34
    
    defaultConfig {
        applicationId "com.audiobooktool"
        minSdk 21
        targetSdk 34
        versionCode 1
        versionName "1.0"
    }
    
    buildTypes {
        release {
            minifyEnabled false
        }
    }
}

dependencies {
    implementation 'androidx.appcompat:appcompat:1.6.1'
}
EOF
            
            # åˆ›å»º gradle.properties
            cat > android/gradle.properties << 'EOF'
org.gradle.jvmargs=-Xmx2048m
android.useAndroidX=true
EOF
            
            echo "âœ… Android project structure created"
          fi
          
          # å¤åˆ¶æ–‡ä»¶åˆ° Android é¡¹ç›®
          echo "ğŸ“‹ Copying files..."
          mkdir -p android/app/src/main/{python,assets}
          
          if [ -d "backend" ]; then
            cp -r backend/* android/app/src/main/python/ 2>/dev/null || true
            echo "âœ… Backend files copied"
          fi
          
          if [ -d "frontend" ]; then
            cp -r frontend/* android/app/src/main/assets/ 2>/dev/null || true
            echo "âœ… Frontend files copied"
          fi

      - name: Generate Gradle Wrapper
        run: |
          cd android
          if [ ! -f "gradlew" ]; then
            echo "ğŸ”§ Generating gradlew..."
            gradle wrapper --gradle-version 8.0
            chmod +x gradlew
          fi

      - name: Build APK
        run: |
          cd android
          
          # ç¡®ä¿ gradlew å¯æ‰§è¡Œ
          chmod +x gradlew
          
          # æ„å»º
          ./gradlew assembleDebug --stacktrace
          
          # éªŒè¯ APK
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "âœ… APK built successfully"
            ls -lh app/build/outputs/apk/debug/app-debug.apk
          else
            echo "âŒ APK build failed"
            exit 1
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: audiobook-tool-debug
          path: android/app/build/outputs/apk/debug/app-debug.apk
